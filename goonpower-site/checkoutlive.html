<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout | GOON Power</title>
  <style>
    :root{ --bg:#0B0B0B; --fg:#F5F5F5; --muted:#DDDDDD; --olive:#4B5320; --accent:#B22222; --accent-dark:#8B1A1A; --card:#1e1e1e; --border:#2d2d2d; }
    *{box-sizing:border-box} body{margin:0;font-family:'Arial Black',sans-serif;background:var(--bg);color:var(--fg)}
    .compact-header{background:#0B0B0B;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--olive)}
    .logo-nav{display:flex;align-items:center;gap:2rem;width:100%;justify-content:space-between}
    .logo-nav img{height:60px}
    nav{display:flex;gap:1.25rem;flex-wrap:wrap;align-items:center}
    nav a{color:#F5F5F5;font-weight:bold;text-decoration:none;font-size:1rem;transition:color .3s;position:relative}
    nav a:hover{color:var(--accent)}
    .badge{position:absolute;top:-10px;right:-12px;background:var(--accent);color:#fff;font-size:.72rem;font-weight:900;border-radius:999px;padding:.05rem .4rem;min-width:1.2rem;text-align:center}

    .wrap{max-width:1100px;margin:0 auto;padding:2rem 1rem}
    h1{margin:0 0 .35rem;color:var(--accent)}
    .sub{color:var(--muted);margin:0 0 1.25rem}
    .back{display:inline-flex;align-items:center;gap:.4rem;color:#bbb;text-decoration:none;margin-bottom:.75rem}
    .back:hover{color:#fff}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:1.25rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
    .card h2{font-size:1.1rem;margin:.25rem 0 .75rem;color:#fff}
    label{display:block;font-size:.95rem;margin:.4rem 0 .25rem}
    input,select,textarea{width:100%;padding:.7rem;border-radius:8px;border:1px solid #3a3a3a;background:#121212;color:#fff}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}

    .pmethods{display:flex;flex-wrap:wrap;gap:.5rem;margin:.25rem 0 1rem}
    .pmethod{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border:1px solid var(--border);border-radius:999px;background:#141414;cursor:pointer}
    .pmethod input{accent-color:var(--accent)}
    .pmethod.active{border-color:var(--accent)}

    .hidden{display:none}
    .paybtn{width:100%;padding:1rem;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:900;cursor:pointer}
    .paybtn:disabled{opacity:.5;cursor:not-allowed}
    .paybtn:hover:not(:disabled){background:var(--accent-dark)}

    .order-summary ul{list-style:none;padding:0;margin:0}
    .order-summary li{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px dashed #333}
    .total{display:flex;justify-content:space-between;margin-top:.5rem;font-size:1rem;color:#ddd}
    .grand{display:flex;justify-content:space-between;margin-top:.6rem;font-size:1.15rem;color:var(--accent);border-top:1px solid #333;padding-top:.6rem}

    .note{font-size:.9rem;color:var(--muted);margin-top:.5rem}
    .error{border-color:#b74a4a !important; box-shadow:0 0 0 2px rgba(183,74,74,.25)}
    .hint{color:#bfbfbf;font-size:.85rem;margin-top:.25rem}

    .ship-methods{display:flex;flex-wrap:wrap;gap:.5rem;margin:.35rem 0 .25rem}
    .ship-methods label{display:inline-flex;align-items:center;gap:.5rem;background:#141414;border:1px solid var(--border);border-radius:999px;padding:.5rem .75rem;cursor:pointer}
    .ship-methods input{accent-color:var(--accent)}
    .coupon-row{display:flex;gap:.5rem;margin-top:.5rem}
    .coupon-row input{flex:1}
    .coupon-row button{padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:#141414;color:#fff;font-weight:900;cursor:pointer}
    .coupon-row button:hover{filter:brightness(.95)}

    .saveinfo{display:flex;align-items:center;gap:.5rem;margin-top:.5rem}
    .agree{display:flex;align-items:center;gap:.5rem;margin-top:.75rem}
    .alert{margin-top:.6rem;padding:.6rem .8rem;border-radius:10px;background:#321515;border:1px solid #6f2f2f;color:#f1c3c3;display:none}
    .ok{margin-top:.6rem;padding:.6rem .8rem;border-radius:10px;background:#15321b;border:1px solid #2f6f3a;color:#c3f1c6;display:none}

    footer{margin-top:2rem;text-align:center;font-size:.9rem;color:#aaa;padding:1.5rem 1rem}

    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="compact-header">
    <div class="logo-nav">
      <img src="images/gpssbannercompact.png" alt="GOON Power Logo">
      <nav>
        <a href="index.html">Home</a>
        <a href="supps.html">Supplements</a>
        <a href="apparel.html">Apparel</a>
        <a href="faq.html">FAQ</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html" id="cartLink">Cart <span class="badge" id="cartBadge">0</span></a>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <a class="back" href="cart.html">&#8592; Return to Cart</a>
    <h1>Secure Checkout</h1>
    <div class="sub">All payments are encrypted. Choose your method below.</div>

    <div class="grid">
      <!-- Left: Customer + Shipping -->
      <div class="card">
        <h2>Customer & Shipping</h2>
        <div class="row">
          <div>
            <label for="first">First Name</label>
            <input id="first" autocomplete="shipping given-name" required />
          </div>
          <div>
            <label for="last">Last Name</label>
            <input id="last" autocomplete="shipping family-name" required />
          </div>
        </div>
        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="email" required />
        <label for="phone">Phone <span class="hint">(optional)</span></label>
        <input id="phone" type="tel" autocomplete="tel" />

        <label for="address">Address</label>
        <input id="address" autocomplete="shipping address-line1" required />
        <div class="row">
          <div>
            <label for="city">City</label>
            <input id="city" autocomplete="address-level2" required />
          </div>
          <div>
            <label for="state">State</label>
            <input id="state" maxlength="2"  autocomplete="address-level1" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="zip">ZIP</label>
            <input id="zip" autocomplete="postal-code" required />
          </div>
          <div>
            <label for="country">Country</label>
            <select id="country">
              <option value="US">United States</option>
            </select>
          </div>
        </div>

        <div class="saveinfo">
          <input id="remember" type="checkbox" checked />
          <label for="remember" style="margin:0">Save my info for next time</label>
        </div>
      </div>

      <!-- Right: Order Summary -->
      <aside class="card order-summary">
        <h2>Order Summary</h2>
        <ul id="summary"></ul>

        <h3 style="margin:.75rem 0 .25rem">Shipping Method</h3>
        <div class="ship-methods">
          <label><input type="radio" name="ship" value="standard" checked>Standard (3–5 days) — $5.99</label>
          <label><input type="radio" name="ship" value="expedited">Expedited (2-day) — $12.99</label>
          <label id="freeShipLabel" class="hidden"><input type="radio" name="ship" value="free">Free (Orders $75+)</label>
        </div>

        <div class="coupon-row">
          <input id="coupon" placeholder="Promo code (e.g., BEAST10, VETERAN15, FREESHIP)" />
          <button id="applyCoupon" type="button">Apply</button>
        </div>
        <div class="note" id="couponMsg"></div>

        <div class="total"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
        <div class="total" id="discountRow" style="display:none"><span>Discount</span><strong id="discount">-$0.00</strong></div>
        <div class="total"><span>Shipping</span><strong id="shipping">$0.00</strong></div>
        <div class="total"><span>Tax</span><strong id="tax">$0.00</strong></div>
        <div class="grand"><span>Total</span><strong id="grand">$0.00</strong></div>
        <div class="note">(Shipping & tax are placeholders.)</div>
      </aside>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Payment Method</h2>
      <div class="pmethods" id="pmethods">
        <label class="pmethod"><input type="radio" name="pm" value="card" checked>Credit/Debit (via Stripe)</label>
        <label class="pmethod"><input type="radio" name="pm" value="paypal">PayPal</label>
        <label class="pmethod"><input type="radio" name="pm" value="venmo">Venmo</label>
        <label class="pmethod"><input type="radio" name="pm" value="apple">Apple Pay</label>
        <label class="pmethod"><input type="radio" name="pm" value="google">Google Pay</label>
      </div>

      <!-- Stripe Checkout (covers Card + Apple Pay + Google Pay on hosted page) -->
      <div id="pay-stripe">
        <label class="agree"><input type="checkbox" id="agree" /> I agree to the terms.</label>
        <button class="paybtn" id="btn-stripe" disabled>Pay Securely</button>
        <div class="note">Card/Apple Pay/Google Pay will appear on Stripe's hosted page when eligible.</div>
      </div>

      <!-- PayPal & Venmo smart buttons -->
      <div id="pay-paypal" class="hidden">
        <div id="paypal-buttons"></div>
        <div class="note">Venmo will appear automatically when eligible.</div>
      </div>

      <div id="payMsg" class="alert"></div>
      <div id="payOk" class="ok"></div>
    </div>
  </div>

  <footer>&copy; 2025 GFPS, LLC | Veteran-Owned | Warren, OH</footer>

  <script>
    // ---- CONFIG: replace before going live ----
    const CONFIG = {
      STRIPE_PUBLISHABLE_KEY: 'pk_live_REPLACE_WITH_YOURS', // safe to expose (publishable key)
      ENDPOINTS: {
        stripeCheckout: '/api/stripe/create-checkout-session',
        paypalCreate: '/api/paypal/create-order',
        paypalCapture: '/api/paypal/capture-order'
      },
      PAYPAL_CLIENT_ID: 'YOUR_PAYPAL_CLIENT_ID' // replace with live or sandbox id
    };

    document.addEventListener('DOMContentLoaded', function(){
      // ---- utils ----
      const $ = (id)=>document.getElementById(id);
      const fmt = n => `$${Number(n||0).toFixed(2)}`;
      const get = id => document.getElementById(id);
      const val = id => (get(id)?.value||'').toString().trim();
      const show = (el,msg)=>{ if(el){ el.textContent = msg||el.textContent; el.style.display='block'; } };
      const hide = (el)=>{ if(el){ el.style.display='none'; } };

      // ---- Cart badge ----
      function updateCartBadge(){
        const cart = JSON.parse(localStorage.getItem('goonCart')||'[]');
        const badge = $('cartBadge'); if(badge) badge.textContent = cart.length;
      }
      updateCartBadge();
      window.addEventListener('storage', updateCartBadge);

      // ---- Load cart + totals ----
      const summary = $('summary');
      const subtotalEl = $('subtotal');
      const discountRow = $('discountRow');
      const discountEl = $('discount');
      const shippingEl = $('shipping');
      const taxEl = $('tax');
      const grandEl = $('grand');
      const couponMsg = $('couponMsg');

      let cart = [];
      let subtotal = 0;
      let discount = 0;
      let shippingCost = 0;
      let shipMethod = 'standard';
      let promo = '';

      function readCart(){
        cart = JSON.parse(localStorage.getItem('goonCart')) || [];
        summary.innerHTML = '';
        subtotal = 0;
        cart.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${item.name}${item.size?` (${item.size})`:''}</span><strong>${fmt(item.price)}</strong>`;
          subtotal += Number(item.price||0);
          summary.appendChild(li);
        });
      }

      // ---- Shipping methods ----
      const shipRadios = document.querySelectorAll('input[name="ship"]');
      const freeShipLabel = $('freeShipLabel');
      function refreshShippingUI(){
        if(subtotal >= 75){ freeShipLabel.classList.remove('hidden'); }
        else { freeShipLabel.classList.add('hidden'); if(shipMethod==='free') shipMethod = 'standard'; document.querySelector('input[name="ship"][value="standard"]').checked = true; }
        if(shipMethod==='expedited') shippingCost = 12.99;
        else if(shipMethod==='free') shippingCost = 0;
        else shippingCost = cart.length ? 5.99 : 0;
      }
      shipRadios.forEach(r=>r.addEventListener('change', (e)=>{shipMethod=e.target.value; renderTotals();}));

      // ---- Promo codes ----
      function applyPromoCode(code){
        promo = (code||'').toUpperCase();
        discount = 0; couponMsg.textContent='';
        if(promo==='BEAST10'){ discount = +(subtotal * 0.10).toFixed(2); couponMsg.textContent='BEAST10 applied: 10% off subtotal.'; }
        else if(promo==='VETERAN15'){ discount = +(subtotal * 0.15).toFixed(2); couponMsg.textContent='VETERAN15 applied: 15% off subtotal.'; }
        else if(promo==='FREESHIP'){ shipMethod = 'free'; discount = 0; couponMsg.textContent='FREESHIP applied: shipping set to $0.'; }
        else if(promo){ couponMsg.textContent='Invalid code.'; promo=''; }
      }
      $('applyCoupon').addEventListener('click', ()=>{ applyPromoCode(val('coupon')); renderTotals(); });

      // ---- Totals ----
      function renderTotals(){
        refreshShippingUI();
        const taxable = Math.max(0, subtotal - discount);
        const tax = +(taxable * 0.07).toFixed(2);
        const grand = Math.max(0, taxable + shippingCost + tax);
        subtotalEl.textContent = fmt(subtotal);
        if(discount>0){ discountRow.style.display='flex'; discountEl.textContent = '-' + fmt(discount).slice(1); }
        else { discountRow.style.display='none'; }
        shippingEl.textContent = fmt(shippingCost);
        taxEl.textContent = fmt(tax);
        grandEl.textContent = fmt(grand);
      }

      // ---- Prefill shipping (draft or last order) ----
      const reqIds = ['first','last','email','address','city','state','zip'];
      const allShipIds = [...reqIds, 'phone','country'];
      function loadDraft(){
        let src = localStorage.getItem('goonCheckoutDraft');
        if(!src){ const last = localStorage.getItem('goonLastOrder'); if(last){ src = JSON.stringify(JSON.parse(last).customer || {}); } }
        if(!src) return;
        try{ const data = JSON.parse(src); allShipIds.forEach(id=>{ if(data[id]) get(id).value = data[id]; }); }catch(e){}
      }
      function autosave(){ if(!$('remember').checked) return; const data = {}; allShipIds.forEach(id=>data[id]=val(id)); localStorage.setItem('goonCheckoutDraft', JSON.stringify(data)); }
      allShipIds.forEach(id=> get(id)?.addEventListener('input', autosave));

      // ---- Validation ----
      function clearErrors(){ reqIds.forEach(id=>get(id)?.classList.remove('error')); hide($('payMsg')); hide($('payOk')); }
      function ensureShippingComplete(){
        clearErrors(); let firstMissing = null;
        reqIds.forEach(id=>{ if(!val(id)){ const el = get(id); if(el){ el.classList.add('error'); if(!firstMissing) firstMissing = el; } } });
        if(firstMissing){ firstMissing.scrollIntoView({behavior:'smooth', block:'center'}); firstMissing.focus(); show($('payMsg'),'Please complete all required shipping fields.'); return false; }
        if(val('email') && !/.+@.+\..+/.test(val('email'))){ get('email').classList.add('error'); get('email').focus(); show($('payMsg'),'Enter a valid email.'); return false; }
        if(val('state') && val('state').length!==2){ get('state').classList.add('error'); get('state').focus(); show($('payMsg'),'Use 2‑letter state code.'); return false; }
        if(val('zip') && !/^\d{5}(-\d{4})?$/.test(val('zip'))){ get('zip').classList.add('error'); get('zip').focus(); show($('payMsg'),'Enter a valid ZIP.'); return false; }
        return true;
      }

      // ---- Build order (client copy) ----
      function buildLocalOrder(paymentMethod){
        const taxBase = Math.max(0, subtotal - discount);
        const tax = +(taxBase * 0.07).toFixed(2);
        const grand = Math.max(0, taxBase + shippingCost + tax);
        const order = {
          id: 'GP-' + Math.random().toString(36).slice(2,8).toUpperCase(),
          placedAt: new Date().toISOString(),
          paymentMethod,
          customer: { first: val('first'), last: val('last'), email: val('email'), phone: val('phone'), address: val('address'), city: val('city'), state: val('state'), zip: val('zip'), country: val('country')||'US' },
          items: cart,
          totals: { subtotal, discount, shipping: shippingCost, tax, grand },
          shipping: { method: shipMethod },
          promo
        };
        localStorage.setItem('goonLastOrder', JSON.stringify(order));
        return order;
      }

      // ---- Payment method switching ----
      const pmRadios = document.querySelectorAll('input[name="pm"]');
      const containers = { stripe: $('pay-stripe'), paypal: $('pay-paypal') };
      function setActive(method){
        document.querySelectorAll('.pmethod').forEach(lbl=>lbl.classList.remove('active'));
        const lbl = document.querySelector(`.pmethod input[value="${method}"]`);
        if(lbl){ lbl.parentElement.classList.add('active'); }
        const stripeLike = (method==='card' || method==='apple' || method==='google');
        containers.stripe.classList.toggle('hidden', !stripeLike);
        containers.paypal.classList.toggle('hidden', stripeLike);
        hide($('payMsg')); hide($('payOk'));
        if(!stripeLike){ maybeRenderPayPal(); }
      }
      pmRadios.forEach(r=>r.addEventListener('change', e=>setActive(e.target.value)));

      // ---- Stripe Checkout ----
      let stripeLoaded = false; let stripe;
      function loadStripe(){
        return new Promise((resolve,reject)=>{
          if(stripeLoaded && stripe) return resolve(stripe);
          const s = document.createElement('script');
          s.src = 'https://js.stripe.com/v3'; s.onload = ()=>{ stripeLoaded = true; try{ stripe = Stripe(CONFIG.STRIPE_PUBLISHABLE_KEY); resolve(stripe); }catch(e){ reject(e); } }; s.onerror = reject; document.head.appendChild(s);
        });
      }

      async function startStripeCheckout(){
        hide($('payMsg')); hide($('payOk'));
        if(!$('agree').checked){ show($('payMsg'),'Please agree to the terms to continue.'); return; }
        if(!ensureShippingComplete()) return;
        if(!CONFIG.STRIPE_PUBLISHABLE_KEY || CONFIG.STRIPE_PUBLISHABLE_KEY.includes('REPLACE')){ show($('payMsg'),'Stripe is not configured yet. Add your publishable key.'); return; }
        try{
          await loadStripe();
          // Prepare payload for server
          const order = buildLocalOrder('stripe'); // client record so confirmation page can render after redirect
          const payload = {
            cart, promo, shippingMethod: shipMethod,
            customer: order.customer,
            successUrl: location.origin + '/secure-order.html#' + order.id,
            cancelUrl: location.origin + '/checkout.html'
          };
          const res = await fetch(CONFIG.ENDPOINTS.stripeCheckout, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('Failed to create Stripe session');
          const data = await res.json();
          const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
          if(error){ show($('payMsg'), error.message || 'Checkout redirect failed.'); }
        }catch(err){ show($('payMsg'), err.message || 'Unable to start Stripe Checkout.'); }
      }
      $('btn-stripe').addEventListener('click', startStripeCheckout);

      // Enable Stripe button when ready
      function updateStripeBtn(){ $('btn-stripe').disabled = !($('agree').checked && ensureShippingComplete()); }
      ['agree', ...reqIds].forEach(id=> get(id)?.addEventListener('input', updateStripeBtn));

      // ---- PayPal / Venmo ----
      let paypalRendered = false;
      async function maybeRenderPayPal(){
        if(paypalRendered) return;
        if(!CONFIG.PAYPAL_CLIENT_ID || CONFIG.PAYPAL_CLIENT_ID.includes('YOUR_')){ show($('payMsg'),'PayPal is not configured yet. Add your client ID.'); return; }
        await loadPayPalSDK();
        paypalRendered = true;
        paypal.Buttons({
          style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'pay' },
          fundingSource: paypal.FUNDING.PAYPAL, // Venmo will auto-appear if eligible
          createOrder: async (data, actions)=>{
            if(!ensureShippingComplete()) { throw new Error('Shipping incomplete'); }
            const order = buildLocalOrder('paypal');
            const res = await fetch(CONFIG.ENDPOINTS.paypalCreate, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cart, promo, shippingMethod: shipMethod, customer: order.customer }) });
            if(!res.ok) throw new Error('Failed to create PayPal order');
            const info = await res.json();
            return info.id; // PayPal orderID
          },
          onApprove: async (data, actions)=>{
            try{
              const res = await fetch(CONFIG.ENDPOINTS.paypalCapture + '?orderId=' + encodeURIComponent(data.orderID), { method:'POST' });
              if(!res.ok) throw new Error('Capture failed');
              window.location.href = 'secure-order.html#' + (JSON.parse(localStorage.getItem('goonLastOrder'))?.id||'');
            }catch(e){ show($('payMsg'), e.message || 'Unable to capture PayPal order.'); }
          },
          onError: (err)=>{ show($('payMsg'), err.message || 'PayPal error.'); }
        }).render('#paypal-buttons');
      }

      function loadPayPalSDK(){
        return new Promise((resolve,reject)=>{
          if(window.paypal) return resolve();
          const src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(CONFIG.PAYPAL_CLIENT_ID)}&intent=capture&currency=USD&components=buttons,marks&enable-funding=venmo,card&disable-funding=paylater,credit`;
          const s = document.createElement('script'); s.src = src; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
        });
      }

      // ---- init ----
      readCart(); loadDraft(); applyPromoCode(''); refreshShippingUI(); renderTotals(); updateStripeBtn(); setActive('card');
    });
  </script>
</body>
</html>
